function onNavigation(a) {
  if (a.progress == 2) player.pause();
}

Flowtime.showProgress(!0);
Flowtime.addEventListener("flowtimenavigation", onNavigation, !1);
Flowtime.start();

$(function() {
  $(".nojavascript").remove();
  
  setInterval(function() {
    $(".showtip").removeClass("showtip").hide().siblings("span").addClass("showtip").fadeIn();
  }, 5000);

  // 表单提交功能（保留核心逻辑）
  $("#write-submit").click(function() {
    var a = {};
    for (var b = 1; b < 79; b++) a[b] = $("#text-" + b).text();
    
    $(".write-ok").fadeIn();
    $("#text-href").focus();
    
    $("#back").click(function() {
      $(".write-ok").fadeOut();
    });

    $("#write-post").click(function() {
      var b = $("#text-href").text(),
          c = $("#text-music").text();
      
      // 输入验证
      if (!b.trim()) {
        showError("#write-url i", "←不能为空");
        return;
      }
      if (!/^[\w\-]{3,30}$/.test(b)) {
        showError("#write-url i", "←格式不正确");
        return;
      }
      if (!c.trim()) {
        showError("#write-mp3 i", "←不能为空");
        return;
      }
      if (!/^(http|https):\/\/([\w-]+\.)+[\w-]+(\/[\w-.\/?%&=]*)?$/.test(c)) {
        showError("#write-mp3 i", "←不允许的链接");
        return;
      }

      // 提交数据
      $("#back").html('<img src="img/loading.gif" alt="loading">');
      $("#write-post").text("页面生成中...").prop("disabled", true).addClass("disabled");
      
      $.post("love.php?add", {
        textHref: b,
        textMusic: c,
        textArr: a
      }, function(res) {
        if (res.status == 1) {
          // 成功处理
          $("#back, .write-ok p, .write-ok div button, .write-ok div h2").hide();
          $(".write-ok div h2").text("成功生成表白❤白页面").fadeIn();
          $("#write-url").html(`您的表白链接是：<a href="${res.url}" target="_blank">${res.url}</a>`).fadeIn();
          $(".write-share").css("display", "inline-block").children("p").show();
        } else {
          // 错误处理
          showError("#write-url i", res.msg);
          $("#back").text("重新修改");
          $("#write-post").text("❤ 生成表白页面").prop("disabled", false).removeClass("disabled");
        }
      }, "json");
    });
  });

  // 背景音乐控制（保留）
  var bgmMusic = document.getElementById("bgmMusic");
  $("#on").click(function() {
    bgmMusic.pause();
    $("#on").hide(200);
    $("#off").css({ display: "inline-block" }, 300);
  });
  
  $("#off").click(function() {
    bgmMusic.play();
    $("#off").hide(200);
    $("#on").css({ display: "inline-block" }, 300);
  });
});

// 通用错误显示函数
function showError(selector, msg) {
  $(selector).text(msg).fadeIn();
  setTimeout(() => $(selector).fadeOut(), 3000);
}
